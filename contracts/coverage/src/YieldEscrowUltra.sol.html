<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/YieldEscrowUltra.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">src/</a> YieldEscrowUltra.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">42.86% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>6/14</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">25% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>3/12</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">50% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>2/4</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">48.28% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>14/29</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;
&nbsp;
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
&nbsp;
/**
 * @title YieldEscrowUltra
 * @dev Ultra-minimal escrow for &lt;100k gas deposits
 * 
 * EXTREME TRADE-OFFS FOR GAS EFFICIENCY:
 * - No access control (public admin functions)
 * - No reentrancy protection
 * - No pause mechanism
 * - Minimal validation
 * - Assembly optimizations
 * - Single storage slot deposits
 * 
 * ⚠️ WARNING: This is for gas benchmarking only!
 * ⚠️ NOT recommended for production use due to security trade-offs!
 */
contract YieldEscrowUltra {
    
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    // STORAGE (ULTRA OPTIMIZED)
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    
    /// @dev Supported tokens (token =&gt; supported)
    mapping(address =&gt; bool) public supportedTokens;
    
    /// @dev Processed payment hashes (hash =&gt; processed)
    mapping(bytes32 =&gt; bool) public processedPaymentHashes;
    
    /// @dev Packed deposit data: user =&gt; depositId =&gt; packedData
    /// PackedData = amount(128) + timestamp(32) + released(8) + padding(88)
    mapping(address =&gt; mapping(uint256 =&gt; uint256)) public packedDeposits;
    
    /// @dev Deposit metadata: user =&gt; depositId =&gt; (token, merchant)
    mapping(address =&gt; mapping(uint256 =&gt; DepositMeta)) public depositMeta;
    
    /// @dev User deposit counts
    mapping(address =&gt; uint256) public userDepositCount;
    
    struct DepositMeta {
        address token;
        address merchant;
    }
    
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    // EVENTS (MINIMAL)
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    
    event DepositCreated(bytes32 indexed paymentHash, address indexed user, uint256 amount);
    event PaymentReleased(bytes32 indexed paymentHash, address indexed user, uint256 amount);
    event TokenSupported(address indexed token, bool supported);
    
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    // ERRORS (MINIMAL)
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    
    error InvalidAmount();
    error TokenNotSupported();
    error PaymentProcessed();
    error DepositNotFound();
    error Unauthorized();
    
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    // CORE FUNCTIONS (ULTRA OPTIMIZED)
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    
    /**
     * @dev Ultra-minimal deposit function targeting &lt;100k gas
     * @param amount Deposit amount (must be &gt; 0 and &lt; 2^128)
     * @param token Token address
     * @param merchant Merchant address
     * @param paymentHash Unique payment hash
     * @return depositIndex The deposit index
     * 
     * EXTREME OPTIMIZATIONS:
     * - Packed storage (amount + timestamp + status in single slot)
     * - Minimal validation
     * - Assembly for gas efficiency
     * - No security modifiers
     */
    function createDeposit(
        uint256 amount,
        address token,
        address merchant,
        bytes32 paymentHash
    ) external returns (uint256 depositIndex) {
        
        // Ultra-minimal validation
        <span class="missing-if-branch" title="if path not taken" >I</span>if (amount == 0 || amount &gt;= 2**128) revert InvalidAmount();
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!supportedTokens[token]) revert TokenNotSupported();
        <span class="missing-if-branch" title="if path not taken" >I</span>if (processedPaymentHashes[paymentHash]) revert PaymentProcessed();
        
        // Get deposit index
        depositIndex = userDepositCount[msg.sender];
        
        // Direct token transfer (no safe transfer for gas savings)
        assembly {
            let token_addr := token
            let from_addr := caller()
            let to_addr := address()
            let amount_val := amount
            
            // Prepare transferFrom call data
            let freeMemPtr := mload(0x40)
            mstore(freeMemPtr, 0x23b872dd00000000000000000000000000000000000000000000000000000000) // transferFrom selector
            mstore(add(freeMemPtr, 0x04), from_addr)
            mstore(add(freeMemPtr, 0x24), to_addr)
            mstore(add(freeMemPtr, 0x44), amount_val)
            
            let success := call(gas(), token_addr, 0, freeMemPtr, 0x64, 0, 0)
            if iszero(success) { revert(0, 0) }
        }
        
        // Pack deposit data: amount(128) + timestamp(32) + released(8) + padding(88)
        uint256 packedData;
        assembly {
            let amount_masked := and(amount, 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF) // 128 bits
            let timestamp_masked := and(timestamp(), 0xFFFFFFFF) // 32 bits
            // released = 0 (false), padding = 0
            packedData := or(amount_masked, shl(128, timestamp_masked))
        }
        
        // Store packed data and metadata
        packedDeposits[msg.sender][depositIndex] = packedData;
        depositMeta[msg.sender][depositIndex] = DepositMeta(token, merchant);
        
        // Update counters with assembly for gas savings
        assembly {
            // userDepositCount[msg.sender]++
            let user := caller()
            let slot := userDepositCount.slot
            let key := user
            let hash := keccak256(add(mload(0x40), 0x20), 0x40)
            mstore(add(mload(0x40), 0x20), key)
            mstore(add(mload(0x40), 0x40), slot)
            let currentCount := sload(hash)
            sstore(hash, add(currentCount, 1))
        }
        
        // Mark payment as processed
        processedPaymentHashes[paymentHash] = true;
        
        // Minimal event
        emit DepositCreated(paymentHash, msg.sender, amount);
    }
    
    /**
     * @dev Release payment to merchant (ultra optimized)
     */
<span class="fstat-no" title="function not covered" >    function releasePayment(address user, uint256 depositIndex) external {</span>
<span class="cstat-no" title="statement not covered" >        uint256 packedData = packedDeposits[user][depositIndex];</span>
<span class="cstat-no" title="statement not covered" >        if (packedData == 0) revert DepositNotFound();</span>
        
<span class="cstat-no" title="statement not covered" >        DepositMeta memory meta = depositMeta[user][depositIndex];</span>
<span class="cstat-no" title="statement not covered" >        if (msg.sender != meta.merchant) revert Unauthorized();</span>
        
        // Check if already released (bit 160 in packed data)
        assembly {
            let releasedBit := and(shr(160, packedData), 0xFF)
            if releasedBit { revert(0, 0) }
        }
        
        // Extract amount from packed data
<span class="cstat-no" title="statement not covered" >        uint256 amount;</span>
        assembly {
            amount := and(packedData, 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF) // Lower 128 bits
        }
        
        // Mark as released
        assembly {
            let newPackedData := or(packedData, shl(160, 1)) // Set released bit
            // Store back
            let userAddr := user
            let index := depositIndex
            // Calculate storage slot for packedDeposits[user][depositIndex]
            let innerSlot := packedDeposits.slot
            mstore(0x00, userAddr)
            mstore(0x20, innerSlot)
            let userMapSlot := keccak256(0x00, 0x40)
            mstore(0x00, index)
            mstore(0x20, userMapSlot)
            let finalSlot := keccak256(0x00, 0x40)
            sstore(finalSlot, newPackedData)
        }
        
        // Transfer to merchant with assembly
        assembly {
            let token_addr := mload(add(meta, 0x00)) // meta.token
            let merchant_addr := mload(add(meta, 0x20)) // meta.merchant
            
            // Prepare transfer call data
            let freeMemPtr := mload(0x40)
            mstore(freeMemPtr, 0xa9059cbb00000000000000000000000000000000000000000000000000000000) // transfer selector
            mstore(add(freeMemPtr, 0x04), merchant_addr)
            mstore(add(freeMemPtr, 0x24), amount)
            
            let success := call(gas(), token_addr, 0, freeMemPtr, 0x44, 0, 0)
            if iszero(success) { revert(0, 0) }
        }
        
<span class="cstat-no" title="statement not covered" >        emit PaymentReleased(bytes32(0), user, amount);</span> // Simplified event
    }
    
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    // ADMIN FUNCTIONS (NO ACCESS CONTROL FOR GAS SAVINGS)
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    
    /**
     * @dev Set token support (no access control for gas savings)
     */
    function setSupportedToken(address token, bool supported) external {
        supportedTokens[token] = supported;
        emit TokenSupported(token, supported);
    }
    
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    // VIEW FUNCTIONS
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════════════
    
    /**
     * @dev Get unpacked deposit data
     */
<span class="fstat-no" title="function not covered" >    function getDeposit(address user, uint256 depositIndex) external view returns (</span>
        uint256 amount,
        uint256 depositTimestamp,
        bool released,
        address token,
        address merchant
    ) {
<span class="cstat-no" title="statement not covered" >        uint256 packedData = packedDeposits[user][depositIndex];</span>
<span class="cstat-no" title="statement not covered" >        DepositMeta memory meta = depositMeta[user][depositIndex];</span>
        
        assembly {
            amount := and(packedData, 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF) // Lower 128 bits
            depositTimestamp := and(shr(128, packedData), 0xFFFFFFFF) // Next 32 bits
            released := and(shr(160, packedData), 0xFF) // Next 8 bits
        }
        
        token = meta.token;
        merchant = meta.merchant;
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Jul 15 2025 00:29:02 GMT+0530 (India Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
